SELECT DISTINCT Item_CD , Item_name 
FROM STDC_Item_Detail;

stdcost folder old การทำงานจะแบ่งเป็น item array link track a ทุกเมนูไปประมวลผลที่ includes/functions.php ประมวลผลและบันทึกข้อมูลลง database  เก็บ log in dir


STD_Cost ต้องการให้นำ functions.php มาต่อยอด เมื่อเก็บ log file ไว้แล้วสามารถนำมาโชว์ได้ว่ามีไฟล์อะไรบ้างอยู่ในนั้นและให้สามารถดาวน์โหลดลงมาได้
	-เปลี่ยนการทำงานในการอัพโหลด functions.phpให้เป็น number(4)_(Number)H.csv
		// ตรวจสอบชื่อไฟล์
        if (preg_match('/^\d{4}_[1-2]H\.csv$/', $filename)) {
            $destination = __DIR__ . '/uploads/' . $filename;
            move_uploaded_file($file['tmp_name'], $destination);



----------------------------------------------------------------------
4 Aug
ต้องการimport csv ที่มีชื่อเช่น 2025_1H.csv,2025_2H.csv โดยที่4ตัวแรกแทนปี_ตัวเลขหนึ่งตัวตาด้วย H .csvลงในเข้าไปในเว็บของเราและเก็บ log file ไว้ โดยที่ก่อนที่จะimport ต้องเช็คว่าชื่อไฟล์นั้นตรงตามformatไหมถึงจะบันทึกลงได้แบบนี้ต้องทำอย่างไร 


message ตอนรีหน้า The page that you're looking for used information that you entered. Returning to that page might cause any action you took to be repeated. Do you want to continue?


-index.php แต่ละเมนูใน Master Input จะมี functions.php เพือ insert ข้อมูลเข้า db แยก table ตามเมนู
-simulate_cal.php จะเป็นการเลือก Year-Period แล้วให้อ่านข้อมูลที่อยู่ใน dir แยกเป็นตาม menu_item ที่มีอยู่ใน Master Input เข้าไปเปรียบเทียบกับ db แต่ละ table เพื่อเช็คว่าข้อมูลที่อ่านจากไฟล์มี column ตรงกันกับใน db table แต่ละ menu item ไหม ถ้าข้อมูลตรง Messageจะไม่แสดงผลอะไร แต่ถ้าหากว่าข้อมูลไม่ตรงกับใน db table column จะแสดงผลใน Message=Error:Invalid column
 


Simulate Cal
=> Patter Process ข้อมูลแต่ละ menu_items ต้องมีแสดงผลอยู่แล้ว statusจะแสดงผลก็ต่อเมื่อมีการนำข้อมูลในไฟล์แต่ละเมนู item อ่านข้อมูล insert เข้าไปที่ table แต่ละเมนูเพื่อเช็คความถูกต้องของข้อมูลและ column เรียบร้อยร้อยแล้วถึงจะแสดงผล ✅ หากมี column ไม่ตรงจะแสดง status=❌ Error:Invalid column หรือหากมีข้อผิดหลาดก็จะแสดงerror 
=== การทำงาน
1. กำหนดรายการ column ที่ “ถูกต้อง” ไว้ล่วงหน้าใน array
2. วนเช็คแต่ละเมนู > โหลดไฟล์ > เช็ค header > เปรียบเทียบกับ column ที่ถูกต้อง
3. ถ้า column ถูกต้อง → Status = ✅
4. ถ้าไม่ตรง → Status = ❌, Message = "Error: Invalid column"

error:
Simulate Calculation
Fiscal Year-Period: 
2022_2H
Prepare Master
Warning: fopen(2022_2H.csv): Failed to open stream: No such file or directory in C:\xampp\htdocs\STD_Cost\pages\simulate_calculation.php on line 107

Fatal error: Uncaught TypeError: fgetcsv(): Argument #1 ($stream) must be of type resource, bool given in C:\xampp\htdocs\STD_Cost\pages\simulate_calculation.php:108 Stack trace: #0 C:\xampp\htdocs\STD_Cost\pages\simulate_calculation.php(108): fgetcsv(false) #1 C:\xampp\htdocs\STD_Cost\index.php(96): include('C:\\xampp\\htdocs...') #2 {main} thrown in C:\xampp\htdocs\STD_Cost\pages\simulate_calculation.php on line 108


page simulate calculation
= การทำงานยังไม่สามารถ check format + insert เข้า table ได้
แต่โชว์เมนูได้แล้ว

<?php
require_once 'config/configdb.php';
require_once 'includes/functions.php';

$stmt = $conn->prepare("SELECT PeriodCode FROM STDC_Periods ORDER BY PeriodCode ASC");
$stmt->execute();
$periods = $stmt->fetchAll(PDO::FETCH_COLUMN);

// Menu items
$menu_items = array(
    'item_detail' => 'ITEM Detail Master',
    'bom_master' => 'BOM_master',
    'std_cost' => 'STD_COST RM',
    'time_manufacturing' => 'Time Manufacturing',
    'std_allocation' => 'Std allocation rate',
    'indirect_allocation_master' => 'Indirect allocation master',
    'indirect_allocation' => 'Indirect allocat rate',
    'allocation_basic' => 'Allocation basic master',
);

// Table mapping
$table_map = array(
    'item_detail' => 'STDC_Item_Detail',
    'bom_master'  => 'STDC_BOM_master',
    'std_cost'    => 'STDC_Std_cost',
    'time_manufacturing' => 'STDC_Time_Manufacturing',
    'std_allocation' => 'STDC_Std_allocation_rate',
    'indirect_allocation_master' => 'STDC_Indirect_allocation_master',
    'indirect_allocation' => 'STDC_Indirect_allocat_rate',
    'allocation_basic' => 'STDC_Allocation_basic_master'
);

function getTableColumns($conn, $tableName) {
    $sql = "SELECT COLUMN_NAME
            FROM INFORMATION_SCHEMA.COLUMNS
            WHERE TABLE_NAME = :tableName
            ORDER BY ORDINAL_POSITION";
    $stmt = $conn->prepare($sql);
    $stmt->execute([':tableName' => $tableName]);
    return $stmt->fetchAll(PDO::FETCH_COLUMN);
}

function validateAndInsertData($conn, $pageKey, $selectedPeriod, $table_map) {
    $folder = __DIR__ . '/../uploads/' . $pageKey;
    $filename = $selectedPeriod . '.csv';
    $filepath = $folder . '/' . $filename;
    
    $result = [
        'status' => '❌',
        'message' => 'File not found'
    ];
    
    // เช็คว่าไฟล์มีอยู่หรือไม่
    if (!file_exists($filepath)) {
        return $result;
    }
    
    try {
        $tableName = $table_map[$pageKey];
        $expectedColumns = getTableColumns($conn, $tableName);
        
        // อ่านหัวคอลัมน์จากไฟล์ CSV
        $handle = fopen($filepath, 'r');
        if ($handle === false) {
            $result['message'] = 'Cannot open file';
            return $result;
        }
        
        $csvHeader = fgetcsv($handle);
        if (!$csvHeader) {
            fclose($handle);
            $result['message'] = 'Invalid CSV format';
            return $result;
        }
        
        // เปรียบเทียบคอลัมน์
        $csvHeaderLower = array_map('strtolower', array_map('trim', $csvHeader));
        $expectedColumnsLower = array_map('strtolower', $expectedColumns);
        
        if ($csvHeaderLower !== $expectedColumnsLower) {
            fclose($handle);
            $result['message'] = 'Error: Invalid column structure';
            return $result;
        }
        
        // ถ้าคอลัมน์ถูกต้อง ให้ลอง insert ข้อมูลลง temp table หรือ validate ข้อมูล
        $conn->beginTransaction();
        
        try {
            // Truncate table ก่อน insert
            $conn->exec("TRUNCATE TABLE $tableName");
            
            // เตรียม insert statement
            $placeholders = implode(',', array_fill(0, count($expectedColumns), '?'));
            $sql = "INSERT INTO $tableName (" . implode(',', $expectedColumns) . ") VALUES ($placeholders)";
            $stmtInsert = $conn->prepare($sql);
            
            $rowIndex = 0;
            $insertCount = 0;
            
            // อ่านและ insert ข้อมูลแต่ละแถว
            while (($data = fgetcsv($handle, 1000, ",")) !== false) {
                $rowIndex++;
                if ($rowIndex === 1) continue; // ข้ามหัวตาราง
                
                if (count($data) < count($expectedColumns)) {
                    continue; // ข้ามแถวที่ข้อมูลไม่ครบ
                }
                
                // ประมวลผลข้อมูลตามประเภทของ pageKey
                $processedData = processDataByPageKey($pageKey, $data, $expectedColumns);
                
                $stmtInsert->execute($processedData);
                $insertCount++;
            }
            
            $conn->commit();
            $result['status'] = '✅';
            $result['message'] = "Success - {$insertCount} records inserted";
            
        } catch (Exception $e) {
            $conn->rollBack();
            $result['message'] = 'Error during data insertion: ' . $e->getMessage();
        }
        
        fclose($handle);
        
    } catch (Exception $e) {
        $result['message'] = 'Error: ' . $e->getMessage();
    }
    
    return $result;
}

function processDataByPageKey($pageKey, $data, $columns) {
    // เงื่อนไข menu std_cost
    if ($pageKey === 'std_cost') {
        // แปลง Std_cost_perunit to decimal
        $colIndex = array_search('Std_cost_perunit', $columns);
        if ($colIndex !== false) {
            $raw = trim(str_replace(',', '', $data[$colIndex]));
            $data[$colIndex] = is_numeric($raw) ? round((float)$raw, 4) : null;
        }
        
        // แปลง Base_qty เป็น int
        $qtyIndex = array_search('Base_qty', $columns);
        if ($qtyIndex !== false) {
            $raw = trim($data[$qtyIndex]);
            $data[$qtyIndex] = is_numeric($raw) ? (int)$raw : null;
        }
    }
    
    // เงื่อนไขของหน้า allocation_basic
    if ($pageKey === 'allocation_basic') {
        foreach (['Non_minus', 'Coefficient_limit', 'Std_alloc'] as $colName) {
            $colIndex = array_search($colName, $columns);
            if ($colIndex !== false && isset($data[$colIndex])) {
                $raw = strtolower(trim($data[$colIndex]));
                $data[$colIndex] = ($raw === 'true' || $raw === '1') ? 1 : 0;
            }
        }
    }
    
    return array_slice($data, 0, count($columns));
}

$selectedPeriod = $_GET['period'] ?? $periods[0] ?? null;

// Handle Prepare Master button click
$prepareResults = [];
if (isset($_POST['prepare_master']) && $selectedPeriod) {
    foreach ($menu_items as $code => $title) {
        $prepareResults[$code] = validateAndInsertData($conn, $code, $selectedPeriod, $table_map);
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulate Calculation</title>
    <link rel="stylesheet" href="css/item_detail.css">
    <style>
        .prepare-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        .prepare-btn:hover {
            background-color: #0056b3;
        }
        .status-success {
            color: green;
            font-weight: bold;
        }
        .status-error {
            color: red;
            font-weight: bold;
        }
        .table-container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h2>Simulate Calculation</h2>
    
    <!-- Period Selection Form -->
    <form method="GET">
        <input type="hidden" name="page" value="simulate_calculation">
        <label for="period">Fiscal Year-Period:</label>
        <select name="period" id="period" onchange="this.form.submit()">
            <?php foreach ($periods as $period): ?>
                <option value="<?= htmlspecialchars($period) ?>" <?= ($period == $selectedPeriod ? 'selected' : '') ?>>
                    <?= htmlspecialchars($period) ?>
                </option>
            <?php endforeach; ?>
        </select>
    </form>

    <?php if ($selectedPeriod): ?>
        <!-- Prepare Master Button -->
        <form method="POST">
            <input type="hidden" name="period" value="<?= htmlspecialchars($selectedPeriod) ?>">
            <button type="submit" name="prepare_master" class="prepare-btn">Prepare Master</button>
        </form>

        <!-- Results Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Process</th>
                        <th>Status</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    <?php 
                    $i = 1;
                    foreach ($menu_items as $code => $title):
                        // ถ้ามีการกด Prepare Master จะใช้ผลลัพธ์จากการประมวลผล
                        if (!empty($prepareResults[$code])) {
                            $status = $prepareResults[$code]['status'];
                            $message = $prepareResults[$code]['message'];
                        } else {
                            // แสดงสถานะเบื้องต้น (เช็คเฉพาะว่าไฟล์มีอยู่หรือไม่)
                            $folder = __DIR__ . '/../uploads/' . $code;
                            $filename = $selectedPeriod . '.csv';
                            $filepath = $folder . '/' . $filename;
                            
                            if (file_exists($filepath)) {
                                $status = '⏳';
                                $message = 'Ready for validation';
                            } else {
                                $status = '❌';
                                $message = 'File not found';
                            }
                        }
                        
                        $statusClass = ($status === '✅') ? 'status-success' : 'status-error';
                    ?>
                        <tr>
                            <td><?= $i++ ?></td>
                            <td><?= htmlspecialchars($title) ?></td>
                            <td class="<?= $statusClass ?>"><?= htmlspecialchars($status) ?></td>
                            <td><?= htmlspecialchars($message) ?></td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    <?php else: ?>
        <p style="color:red">No period found. Please insert at least one Period in the system.</p>
    <?php endif; ?>
</body>
</html>



Columns table 
	item detail master = 36417
	Bom master = 118359
	STD-RM = 1467
	Time manufac = 21297
	Std allocation rate = 3436
	Indirect allocation master = 1828
	Indirect allocate rate = 259
	Allocation basic master = 265


Status = ✅
HTML Tabel Select Item Calculation
 
---------------------------------------------------------------------------------
6 July   ต้องไปหาวิธีแก้ icon logo ให้ได้ 
***knowlage 
	-temp table เป็น table ชั่วคราว “ต้องสร้างใหม่ทุกครั้ง” หมายถึง
Temp Table ไม่คงอยู่ถาวรในระบบ คุณต้อง CREATE TABLE มันใหม่เสมอทุกครั้งที่จะใช้งาน เพราะมันจะถูกลบทิ้งโดยอัตโนมัติหลัง session/stored procedure จบ
	-Dummy ข้อมูล ตัวแปร หรือตารางที่สร้างขึ้นมาเพื่อใช้ทดสอบระบบ หรือแทนที่ข้อมูลจริงชั่วคราว

สร้าง procedure SP_STDC_Calculation_List  @FicalYear

/*ตัวอย่างคำสั่ง create temp table in procedure*/
-- เช็คและลบ temp table เดิม (ถ้ามีอยู่แล้ว)
IF OBJECT_ID('tempdb..#ItemTemp') IS NOT NULL
    DROP TABLE #ItemTemp;

-- สร้าง temp table
CREATE TABLE #ItemTemp (
    item_code VARCHAR(20),
    item_name NVARCHAR(100),
    Status NVARCHAR(20)
);

-- เพิ่มข้อมูล
INSERT INTO #ItemTemp (item_code, item_name, Status)
VALUES   /*เป็นการ dummy ข้อมูล*/
('2100002052', 'V-BELT W800 SB107', 'Confirmed'),
('2100002053', 'V-BELT W800 SB108', 'Confirmed'),
('2100002054', 'V-BELT W800 SB109', 'Confirmed'),
('2100002055', 'V-BELT W800 SB110', 'Confirmed');
 
-- พี่สน จะมาทำต่อ


-- ใช้งานข้อมูล (แสดงผล)
SELECT * FROM #ItemTemp;

-- ลบ temp table หลังใช้งานเสร็จ
DROP TABLE #ItemTemp;


store procedure ที่ใช้จริง 
ALTER PROCEDURE [dbo].[SP_STDC_Calculation_List]
	@FicalYear VARCHAR(20)
AS
BEGIN
	SET NOCOUNT ON;
	-- routine body goes here, e.g.
	-- SELECT 'Navicat for SQL Server'
-- 	check และลบ temp table เดิมถ้ามีอยู่แล้ว
	IF OBJECT_ID('tempdb..#ItemCalculationTemp') IS NOT NULL
		DROP TABLE #ItemCalculationTemp;
		
	-- 	crete temp TABLE
	CREATE TABLE #ItemCalculationTemp(
			item_code VARCHAR(20),
			item_name NVARCHAR(100),
			Status NVARCHAR(20)
	);


	-- insert 
	INSERT INTO #ItemCalculationTemp (item_code, item_name, Status)
	VALUES
	('2100002052','V-BELT W800 SB107','Confirmed'),		
	('2100002053','V-BELT W800 SB108','Confirmed'),		
	('2100002054','V-BELT W800 SB109','Confirmed'),		
	('2100002055','V-BELT W800 SB110','Confirmed'),		
	('2100002056','V-BELT W800 SB111','Confirmed'),		
	('2100002057','V-BELT W800 SB112','Confirmed'),	
	('2100002058','V-BELT W800 SB113','Confirmed'),
	('2100002059','V-BELT W800 SB114','New'),	
	('2100002060','V-BELT W800 SB115','New'),	
	('2100002061','V-BELT W800 SB116','New');	

-- พี่สน จะมาทำต่อ

-- ใช้งานข้อมูล (แสดงผล)
SELECT * FROM #ItemCalculationTemp;
	
END
การดึงข้อมูลมาโชว์
// เช็คว่าสถานะเตรียมข้อมูลผ่านหรือไม่ (ถ้าใช้ตัวแปรนี้จริง)
$allSuccess = !empty($prepareResults) && array_reduce($prepareResults, function ($carry, $item) {
    return $carry && ($item['status'] === '✅');
}, true);

// ปีงบประมาณที่ใช้ส่งเข้า stored procedure
$ficalYear = '2025';

try {
    // เรียก stored procedure
    $stmt = $conn->prepare("EXEC SP_STDC_Calculation_List @FicalYear = :ficalYear");
    $stmt->bindParam(':ficalYear', $ficalYear);
    $stmt->execute();

    // ดึงข้อมูลและเปลี่ยน key ให้เป็นพิมพ์เล็กทั้งหมด
    $itemCalculations = array_map('array_change_key_case', $stmt->fetchAll(PDO::FETCH_ASSOC));
    $hasData = !empty($itemCalculations);
} catch (PDOException $e) {
    die("Database error: " . $e->getMessage());
}

//remark
	loading ระหว่างประมวลผลหลังจากกด Prepare Master
	loading ระหว่าง start calculation =Run Simulation Please wait...
	-ยังติดปัญหา simulate_calculation.php= cencelButtonText


------------------------------------------------------
7 Aug 
batch in php = การประมวลผลข้อมูลเป็นกลุ่มๆ (batch) แทนที่จะทำทีละรายการ  
     ตัวอย่างการทำงาน หากคุณมีข้อมูล 10,000 แถว แทนที่จะประมวลผลทั้งหมดพร้อมกัน คุณอาจแบ่งเป็น batch ละ 1,000 แถว เพื่อประหยัดหน่วยความจำ:
CREATE PROCEDURE เสร็จแล้ว 5PM


------------------------------------------------------
8 Aug
20251H, 2100000001 เทสไม่ได้

จากโค้ดทั้งหมดที่ให้ไปก่อนก่อนหน้าต้องการการทำงานเพิ่มเติมโดยไม่กระทบการทำงานหลักดังนี้ 1.
หลังจากกดปุ่ม Start Calในหน้า simulate_calculation.php การเลือก itemก่อนหน้าจะไม่ส่งผลอะไรใดๆ แต่เมื่อกดปุ่ม start cal จะประมวลผลข้อมูล ภายใน store procedure ดังนี้ 
1.if show php check count rows in database from #STDC_TempCalItem_Count=if count success: icon check mark ,Error x 
2.if need select #STDC_Calculation_log  show log file .txt data in #STDC_Calculation_log แค่โชว์ชื่อไฟล์มาให้ และปุ่มดาน์โหลเพื่อจะโหลด .txtไปดู 
3. if need select #STDC_Calculation_Results_temp show .csv data in file #STDC_Calculation_Results_temp  แค่โชว์ชื่อไฟล์มาให้ และปุ่มดาน์โหลเพื่อจะโหลด .csv ไปดู 

ใช้คำสั่ง SELECT COUNT(*) AS RowCount คำสั่งนี้ไม่ได้ แต่ใช้คำสั่ง SELECT COUNT(*) FROM #STDC_TempCalItem_Count; ได้


--------------------
Annpun
แบ่งเป็น categoey
-Company Announument
-Company Order



